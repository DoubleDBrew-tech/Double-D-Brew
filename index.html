<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Double'd Brew Inventory</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #f8f9fa; }
.card h2 { font-size: 2rem; }
#app { display: none; }
#loginForm { height: 100vh; display: flex; align-items: center; justify-content: center; }
.login-box { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 350px; text-align: center; }
.login-box h2 { margin-bottom: 20px; color: #6b4226; }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginForm">
  <div class="login-box">
    <h2>Double'd Brew Login</h2>
    <input type="text" id="username" class="form-control mb-2" placeholder="Username" required>
    <input type="password" id="password" class="form-control mb-3" placeholder="Password" required>
    <button class="btn btn-primary w-100" onclick="login()">Login</button>
  </div>
</div>

<!-- INVENTORY APP -->
<div id="app">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Double'd Brew Inventory</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link active" href="#" onclick="showDashboard()">Dashboard</a></li>
        </ul>
        <button class="btn btn-outline-light me-2" onclick="exportCSV()">Export CSV</button>
        <button class="btn btn-warning" onclick="logout()">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container py-4" id="main"></div>
</div>

<script>
// ---------- LOGIN SYSTEM ----------
document.addEventListener("DOMContentLoaded", () => {
  const loggedIn = localStorage.getItem("loggedIn");
  if (loggedIn === "true") {
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("app").style.display = "block";
    loadProducts();
  } else {
    document.getElementById("loginForm").style.display = "flex";
  }
});

function login() {
  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  if (user === "admin" && pass === "password123") {
    localStorage.setItem("loggedIn", "true");
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("app").style.display = "block";
    loadProducts();
  } else {
    alert("Invalid username or password!");
  }
}

function logout() {
  localStorage.removeItem("loggedIn");
  document.getElementById("app").style.display = "none";
  document.getElementById("loginForm").style.display = "flex";
}

// ---------- INVENTORY DATA ----------
let products = [];
let previousStocks = {};

// ---------- DASHBOARD ----------
function showDashboard() {
  let totalItems = products.reduce((sum, p) => sum + p.stock, 0);
  let totalValue = products.reduce((sum, p) => sum + p.stock * p.price, 0);
  let tableRows = products.map(p => `
    <tr>
      <td>${p.sku}</td>
      <td>${p.name}</td>
      <td>${p.stock}</td>
      <td>₱${p.price.toFixed(2)}</td>
      <td>${p.reorder_threshold}</td>
    </tr>
  `).join("");

  document.getElementById("main").innerHTML = `
    <div class="row mb-4">
      <div class="col-md-4"><div class="card p-3"><h5>Total Products</h5><h2>${products.length}</h2></div></div>
      <div class="col-md-4"><div class="card p-3"><h5>Total Items</h5><h2>${totalItems}</h2></div></div>
      <div class="col-md-4"><div class="card p-3"><h5>Total Value</h5><h2>₱${totalValue.toFixed(2)}</h2></div></div>
    </div>
    <div class="d-flex justify-content-between mb-3">
      <h4>Products</h4>
      <button class="btn btn-primary" onclick="addProduct()">Add Product</button>
    </div>
    <table class="table table-striped">
      <thead><tr><th>SKU</th><th>Name</th><th>Stock</th><th>Price</th><th>Threshold</th></tr></thead>
      <tbody>${tableRows}</tbody>
    </table>
  `;
}

// ---------- ADD PRODUCT ----------
function addProduct() {
  document.getElementById("main").innerHTML = `
    <h3>Add New Product</h3>
    <form id="addForm">
      <input type="text" name="sku" class="form-control mb-2" placeholder="SKU" required>
      <input type="text" name="name" class="form-control mb-2" placeholder="Product Name" required>
      <input type="text" name="description" class="form-control mb-2" placeholder="Description">
      <input type="number" name="price" class="form-control mb-2" placeholder="Price" required>
      <input type="number" name="stock" class="form-control mb-2" placeholder="Stock" required>
      <input type="number" name="reorder" class="form-control mb-3" placeholder="Reorder Threshold" required>
      <button class="btn btn-success" type="submit">Save Product</button>
      <button class="btn btn-secondary ms-2" type="button" onclick="showDashboard()">Cancel</button>
    </form>
  `;
  document.getElementById("addForm").addEventListener("submit", saveNewProduct);
}

// ---------- EXPORT CSV ----------
function exportCSV() {
  let now = new Date();
  let timestamp = now.toLocaleString();
  let csv = "Timestamp,SKU,Name,Description,Previous Stock,Current Stock,Price,Threshold\n";
  products.forEach(p => {
    let prevStock = previousStocks[p.sku] !== undefined ? previousStocks[p.sku] : p.stock;
    csv += `${timestamp},${p.sku},${p.name},${p.description || ""},${prevStock},${p.stock},${p.price},${p.reorder_threshold}\n`;
    previousStocks[p.sku] = p.stock;
  });

  let blob = new Blob([csv], { type: "text/csv" });
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "inventory.csv";
  a.click();
}
</script>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA1smwaGZUVzA01JXjcv7hkSNdf0eRVB0w",
  authDomain: "doubledbrew-569cd.firebaseapp.com",
  projectId: "doubledbrew-569cd",
  storageBucket: "doubledbrew-569cd.appspot.com",
  messagingSenderId: "28995576921",
  appId: "1:28995576921:web:597ac212cce2eb7066fd48"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function loadProducts() {
  const querySnapshot = await getDocs(collection(db, "products"));
  window.products = [];
  querySnapshot.forEach((doc) => {
    window.products.push({ id: doc.id, ...doc.data() });
  });
  window.showDashboard();
}

async function saveNewProduct(e) {
  e.preventDefault();
  const form = e.target;
  const newP = {
    sku: form.sku.value,
    name: form.name.value,
    description: form.description.value,
    price: parseFloat(form.price.value),
    stock: parseInt(form.stock.value),
    reorder_threshold: parseInt(form.reorder.value)
  };
  await addDoc(collection(db, "products"), newP);
  await loadProducts();
}

window.loadProducts = loadProducts;
window.saveNewProduct = saveNewProduct;
</script>

</body>
</html>
